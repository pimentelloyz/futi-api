name: Prisma Migrate (deploy)

on:
  workflow_dispatch:
    inputs:
      migrateStatus:
        description: "Run prisma migrate status before deploy"
        required: false
        default: "true"
      previewFeature:
        description: "Allow preview/experimental migrations (rare)"
        required: false
        default: "false"

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies (with dev)
        run: npm ci

      - name: Prisma migrate status
        if: ${{ inputs.migrateStatus == 'true' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate status

      - name: Prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PRISMA_MIGRATE_SKIP_GENERATE: 'true'
          PRISMA_TELEMETRY_INFORMATION: 'github-actions'
        run: |
          if [ "${{ inputs.previewFeature }}" = "true" ]; then
            npx prisma migrate deploy --preview-feature || true
          else
            npx prisma migrate deploy
          fi
